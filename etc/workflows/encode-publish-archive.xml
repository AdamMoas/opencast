<?xml version="1.0" encoding="UTF-8"?>
<definition xmlns="http://workflow.opencastproject.org">

  <id>encode-publish-archive</id>
  <title>Encode, publish and archive</title>
  <description>
    Encode audio and video formats to the distribution formats that are required by the Engage publication channel.
    Apply the video segmentation algorithm to the presentation tracks and extract segment preview images and metadata.
    Send the encoded material along with the metadata to the publication channels.
    Store everything that has been tagged accordingly in the archive.
  </description>

  <configuration_panel></configuration_panel>

  <operations>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- Encode for publication to Engage                                  -->
    <!--                                                                   -->
    <!-- Encode audio and video formats to the distribution formats that   -->
    <!-- are required by the Engage publication channel.                   -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <!-- Encode to engage search result thumbnails -->

    <operation
      id="image"
      fail-on-error="true"
      exception-handler-workflow="error"
      description="Creating Engage search result thumbnails">
      <configurations>
        <configuration key="source-flavor">*/trimmed</configuration>
        <configuration key="source-tags"></configuration>
        <configuration key="target-flavor">*/search+preview</configuration>
        <configuration key="target-tags">engage-download</configuration>
        <configuration key="encoding-profile">search-cover.http</configuration>
        <configuration key="time">1</configuration>
      </configurations>
    </operation>

    <!-- Encode to engage player preview images -->

    <operation
      id="image"
      fail-on-error="true"
      exception-handler-workflow="error"
      description="Creating Engage player preview image">
      <configurations>
        <configuration key="source-flavor">*/trimmed</configuration>
        <configuration key="source-tags"></configuration>
        <configuration key="target-flavor">*/player+preview</configuration>
        <configuration key="target-tags">engage-download</configuration>
        <configuration key="encoding-profile">player-preview.http</configuration>
        <configuration key="time">1</configuration>
      </configurations>
    </operation>

    <!-- Encode presenter (camera) to Engage player format -->

    <operation
      id="compose"
      fail-on-error="true"
      exception-handler-workflow="error"
      description="Encoding presenter (camera) video to MP4 download">
      <configurations>
        <configuration key="source-flavor">presenter/trimmed</configuration>
        <configuration key="target-flavor">presenter/delivery</configuration>
        <configuration key="target-tags">engage-download,engage-streaming</configuration>
        <configuration key="encoding-profile">flash.http</configuration>
      </configurations>
    </operation>

    <!-- Encode presentation (vga) to Engage player format -->

    <operation
      id="compose"
      fail-on-error="true"
      exception-handler-workflow="error"
      description="Encoding presentation (screen) to MP4 download">
      <configurations>
        <configuration key="source-flavor">presentation/trimmed</configuration>
        <configuration key="target-flavor">presentation/delivery</configuration>
        <configuration key="target-tags">engage-download,engage-streaming</configuration>
        <configuration key="encoding-profile">flash-vga.http</configuration>
      </configurations>
    </operation>

    <!-- Encode presentater (camera) to Engage player audio only format -->

    <operation
      id="compose"
      fail-on-error="false"
      exception-handler-workflow="error"
      description="Encoding presenter (screen) to MP3 audio download">
      <configurations>
        <configuration key="source-flavor">presenter/trimmed</configuration>
        <configuration key="target-flavor">presenter/delivery</configuration>
        <configuration key="target-tags">engage-download,engage-streaming</configuration>
        <configuration key="encoding-profile">flash-audio.http</configuration>
      </configurations>
    </operation>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- Concat bumper and trailer videos                                  -->
    <!--                                                                   -->
    <!-- Concat the bumper and trailer video to the presenter and          -->
    <!-- presentation videos as intro/outro.                               -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <!-- Untag non-concatenated delivery videos for publishing -->

    <operation
      id="tag"
      if="${theme}"
      description="Untag non-concatenated delivery videos for publishing">
      <configurations>
        <configuration key="source-flavors">*/delivery</configuration>
        <configuration key="target-tags">-engage-download,-engage-streaming</configuration>
      </configurations>
    </operation>

    <!-- Add bumper and trailer part to the presenter track -->

    <operation
      id="concat"
      if="${theme}"
      fail-on-error="true"
      exception-handler-workflow="error"
      description="Concatenate the presenter track and the intro/outro videos.">
      <configurations>
        <configuration key="source-flavor-part-0">branding/bumper</configuration>
        <configuration key="source-flavor-part-1">presenter/delivery</configuration>
        <configuration key="source-flavor-part-1-mandatory">true</configuration>
        <configuration key="source-flavor-part-2">branding/trailer</configuration>
        <configuration key="target-flavor">presenter/delivery</configuration>
        <configuration key="target-tags">engage-download,engage-streaming</configuration>
        <configuration key="encoding-profile">concat.work</configuration>
        <configuration key="output-resolution">part-1</configuration>
      </configurations>
    </operation>

    <!-- Add bumper and trailer part to the presentation track -->

    <operation
      id="concat"
      if="${theme}"
      fail-on-error="true"
      exception-handler-workflow="error"
      description="Concatenate the presentation track and the intro/outro videos.">
      <configurations>
        <configuration key="source-flavor-part-0">branding/bumper</configuration>
        <configuration key="source-flavor-part-1">presentation/delivery</configuration>
        <configuration key="source-flavor-part-1-mandatory">true</configuration>
        <configuration key="source-flavor-part-2">branding/trailer</configuration>
        <configuration key="target-flavor">presentation/delivery</configuration>
        <configuration key="target-tags">engage-download,engage-streaming</configuration>
        <configuration key="encoding-profile">concat.work</configuration>
        <configuration key="output-resolution">part-1</configuration>
      </configurations>
    </operation>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- Segment video streams and extract metadata                        -->
    <!--                                                                   -->
    <!-- Apply the video segmentation algorithm to the presentation tracks -->
    <!-- and extract segment preview images and metadata.                  -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <!-- Run the videosegmentation -->

    <operation
      id="segment-video"
      fail-on-error="false"
      exception-handler-workflow="error"
      description="Detecting slide transitions in presentation track">
      <configurations>
        <configuration key="source-flavor">presentation/trimmed</configuration>
        <configuration key="target-tags">engage-download</configuration>
      </configurations>
    </operation>

    <!-- Generate segment preview images -->

    <operation
      id="segmentpreviews"
      fail-on-error="false"
      exception-handler-workflow="error"
      description="Creating preview images for presentation segments">
      <configurations>
        <configuration key="source-flavor">presentation/trimmed</configuration>
        <configuration key="target-flavor">presentation/segment+preview</configuration>
        <configuration key="reference-flavor">presentation/delivery</configuration>
        <configuration key="reference-tags">engage-download</configuration>
        <configuration key="target-tags">engage-download</configuration>
        <configuration key="encoding-profile">player-slides.http</configuration>
      </configurations>
    </operation>

    <!-- Extract text form slide preview images -->

    <operation
      id="extract-text"
      fail-on-error="false"
      exception-handler-workflow="error"
      description="Extracting text from presentation segments">
      <configurations>
        <configuration key="source-flavor">presentation/trimmed</configuration>
        <configuration key="target-tags">engage-download,archive</configuration>
      </configurations>
    </operation>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- Publish to publication channels                                   -->
    <!--                                                                   -->
    <!-- Send the encoded material along with the metadata to the          -->
    <!-- publication channels.                                             -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <!-- Publish to engage player -->

    <operation
      id="publish-engage"
      if="${publishEngage}"
      max-attempts="2"
      fail-on-error="true"
      exception-handler-workflow="error"
      description="Publishing to Engage">
      <configurations>
        <configuration key="download-source-tags">engage-download,atom,rss,mobile</configuration>
        <configuration key="streaming-source-tags">engage-streaming</configuration>
        <configuration key="check-availability">true</configuration>
      </configurations>
    </operation>

    <!-- Publish to internal distribution -->

    <operation
      id="publish-internal"
      max-attempts="2"
      fail-on-error="true"
      exception-handler-workflow="error"
      description="Publishing to internal distribution">
      <configurations>
        <configuration key="source-tags">internal</configuration>
      </configurations>
    </operation>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- Archive                                                           -->
    <!--                                                                   -->
    <!-- Store everything that has been tagged accordingly in the archive. -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <!-- Archive the current state of the mediapackage -->

    <operation
      id="archive"
      fail-on-error="true"
      exception-handler-workflow="error"
      description="Archiving">
      <configurations>
        <configuration key="source-tags">archive</configuration>
      </configurations>
    </operation>

  </operations>
</definition>
