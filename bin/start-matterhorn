#!/bin/bash

echo
echo '  *****************************************************************'
echo '  *                                                               *'
echo '  *   Warning: | This script is for development only.             *'
echo '  *            | It starts Opencast with debugging enabled.       *'
echo '  *            | Do not use it for production. It is insecure.    *'
echo '  *                                                               *'
echo '  *****************************************************************'
echo

# Load default configuration
OPENCAST_HOME_DIR=$(cd $(dirname "$0")/.. && pwd -P)
echo "Using Opencast installation at $OPENCAST_HOME_DIR"

LOGDIR=$OPENCAST_HOME_DIR/logs
LOGLEVEL="WARN"
ECLIPSE_LOGLEVEL="CONFIG"
FELIX_CONFIG_DIR=$OPENCAST_HOME_DIR/etc
FELIX_WORK_DIR=$OPENCAST_HOME_DIR/work
FELIX_CACHE_DIR="${FELIX_WORK_DIR}/felix-cache"
MATTERHORN_TEMP_DIR="${FELIX_WORK_DIR}/tmp"

# Check lib dir exists
[ -d "$OPENCAST_HOME_DIR/lib/matterhorn" ] || \
  ( echo 'ERROR: Opencast jars not found at $OPENCAST_HOME_DIR/lib/matterhorn. Exiting...' && exit )

###
# The following is for the actual Opencast start
##

FELIX="-Dfelix.home=$OPENCAST_HOME_DIR"
FELIX="${FELIX} -Dfelix.work=$FELIX_WORK_DIR"
FELIX="${FELIX} -Dfelix.config.properties=file:${FELIX_CONFIG_DIR}/config.properties"
FELIX="${FELIX} -Dfelix.system.properties=file:${FELIX_CONFIG_DIR}/system.properties"
FELIX="${FELIX} -Dfelix.fileinstall.dir=$FELIX_CONFIG_DIR/load"
FELIX="${FELIX} -Dfelix.fileinstall.dir=$FELIX_CONFIG_DIR/load"

# Configure Java Management Extensions (JMX)
JMX="-Dcom.sun.management.jmxremote"
JMX="${JMX} -Dcom.sun.management.jmxremote.port=1099"
JMX="${JMX} -Dcom.sun.management.jmxremote.authenticate=false"
JMX="${JMX} -Dcom.sun.management.jmxremote.ssl=false"

LOGGING="-Dopencast.logdir=$LOGDIR"
LOGGING="${LOGGING} -Dbundles.configuration.location=$FELIX_CONFIG_DIR"
LOGGING="${LOGGING} -Djava.util.logging.config.file=$FELIX_CONFIG_DIR/services/java.util.logging.properties"
LOGGING="${LOGGING} -Dorg.ops4j.pax.logging.DefaultServiceLog.level=${LOGLEVEL}"
LOGGING="${LOGGING} -Declipselink.logging.level=${ECLIPSE_LOGLEVEL}"

# This is needed by matterhorn-videosegmenter-impl
# It can probably be removed once the module is removed
GRAPHICS="-Djava.awt.headless=true"
GRAPHICS="${GRAPHICS}"

JETTY="-Dorg.mortbay.jetty.Request.maxFormContentSize=1000000"

DISABLE_PHONEHOME="-Dnet.sf.ehcache.skipUpdateCheck=true"
DISABLE_PHONEHOME="${DISABLE_PHONEHOME} -Dorg.terracotta.quartz.skipUpdateCheck=true"

# Configure temporary files
JAVA="-Djava.io.tmpdir=$OPENCAST_TEMP_DIR"

# Set memory allocation options
# -XX:MaxPermSize has been removed in OpenJDK >= 8
# Hence we should remove this options once we discontinue support for Java 7
JAVA="${JAVA} -Xms1g -Xmx1g -XX:MaxPermSize=256m"

# Configure debug access
DEBUG="-Xdebug -Xnoagent -Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=n"

OPENCAST_OPTS="$GOSH $DEBUG $FELIX $GRAPHICS $JETTY $JAVA $LOGGING $JMX $DISABLE_PHONEHOME $ADD_OPTS"

# Make sure matterhorn bundles are reloaded
rm -rf $FELIX_CACHE_DIR

set -o monitor
pushd $OPENCAST_HOME_DIR &> /dev/null
java $OPENCAST_OPTS -jar $OPENCAST_HOME_DIR/bin/felix.jar $FELIX_CACHE_DIR
popd &> /dev/null
